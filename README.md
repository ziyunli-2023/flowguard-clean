# FlowGuard

A clean, refactored implementation of the FlowGuard filtering algorithm for flow-based generative models.

## Overview

FlowGuard is a quality filtering method for samples generated by flow-based models. It uses step residual scoring to identify and filter out low-quality samples during the generation process.

## Features

- **Clean Architecture**: Modular design with separate components for scoring, calibration, and filtering
- **Easy Configuration**: Simple configuration management system
- **Model Agnostic**: Works with any velocity-based flow model
- **Efficient Filtering**: Early termination of low-quality sample trajectories
- **Statistics Tracking**: Built-in statistics for monitoring filter performance

## Installation

```bash
pip install -e .
```

## Quick Start

```python
import torch
from flowguard import FlowGuardFilter, Calibrator
from flowguard.utils import FlowGuardConfig

# Configure
config = FlowGuardConfig(alpha=0.1, n_steps=30)

# Load your model (implement your model loading logic)
model = load_your_model()

# Calibrate threshold
calibrator = Calibrator()
tau = calibrator.calibrate(
    model=model,
    data_shape=(3, 32, 32),  # e.g., CIFAR-10
    alpha=config.alpha,
    n_steps=config.n_steps
)

# Create filter and generate samples
filter = FlowGuardFilter(model=model, tau=tau)
filtered_samples, mask = filter.generate_filtered(
    batch_size=1024,
    data_shape=(3, 32, 32),
    n_steps=config.n_steps
)

# Check statistics
stats = filter.get_stats()
print(f"Filter rate: {stats.get_filter_percentage():.2f}%")
```

## Core Components

### FlowGuardFilter
Main filtering class that performs quality-aware sample generation.

### Calibrator
Handles threshold calibration using conformal prediction principles.

### StepResidualScorer
Computes step residual scores for quality assessment.

### FlowGuardConfig
Configuration management for all parameters.

## Examples

See `examples/cifar10_example.py` for a complete usage example.

## Project Structure

```
flowguard-clean/
├── flowguard/
│   ├── core/           # Core filtering algorithms
│   ├── models/         # Model wrapper utilities
│   └── utils/          # Configuration and utilities
├── examples/           # Usage examples
└── tests/             # Unit tests
```